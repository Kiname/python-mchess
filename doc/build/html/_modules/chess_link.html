
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>chess_link &#8212; mchess 0.1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for chess_link</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">chess_link_protocol</span> <span class="k">as</span> <span class="nn">clp</span>

<span class="c1"># See document `magic-board.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;_</span>
<span class="c1"># for details on the Chess Link protocol.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Chess Link Protocol</span>

<span class="sd">```</span>
<span class="sd">&lt;V56&gt;</span>
<span class="sd">2018-08-31 11:07:31,141 DEBUG ChessLinkBluePy Sending: &lt;b&#39;\xd6\xb5\xb6&#39;&gt;</span>
<span class="sd">2018-08-31 11:07:31,212 DEBUG ChessLinkBluePy BLE: Handle: 55, data: b&#39;v\xb01\xb0\xb374&#39;</span>
<span class="sd">2018-08-31 11:07:31,212 DEBUG ChessLinkBluePy BLE received [v010374]</span>
<span class="sd">2018-08-31 11:07:31,212 DEBUG ChessLinkBluePy bluepy_ble received complete msg: v010374</span>
<span class="sd">```</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ChessLink"><a class="viewcode-back" href="../index.html#chess_link.ChessLink">[docs]</a><span class="k">class</span> <span class="nc">ChessLink</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This implements the &#39;Chess Link&#39; protocol for Millennium Chess Genius Exclusive and future boards </span>
<span class="sd">    compatible with that protocol</span>

<span class="sd">    For the details of the Chess Link protocol, please refer to: </span>
<span class="sd">    `magic-link.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;`_.</span>

<span class="sd">    `position` array</span>

<span class="sd">    This class refers to chess boards using the `position` 8x8 array. Field values: 1: white pawn, </span>
<span class="sd">    2: w-knight, 3: w-bishop, 4: w-rook, 5: w-queen, 6: w-king, 0: empty square, -1; black pawn, </span>
<span class="sd">    -2: b-knight, -3: b-bishop, -4: b-rook, -5: b-queen, -6: b-king.</span>

<span class="sd">    Communcation with the Chess Link board is asynchronous. Replies from the board are written</span>
<span class="sd">    to the python queue (`appqueue`) that is provided during instantiation.</span>

<span class="sd">    Every message in `appqueue` is a short json string. Currently implemented are:</span>

<span class="sd">    Version::</span>

<span class="sd">        {&#39;version&#39;: &#39;01.04&#39;, &#39;actor&#39;: &#39;&lt;actor-name&gt;&#39;}</span>

<span class="sd">    New game detected (board has been set to start position)::</span>

<span class="sd">        {&#39;new game&#39;, &#39;&#39;, &#39;actor&#39;: &#39;&lt;actor-name&gt;&#39;, &#39;orientation&#39;: True}</span>

<span class="sd">    Transport error::</span>

<span class="sd">        {&#39;error&#39;: &#39;&lt;error message&gt;&#39;, &#39;actor&#39;: &#39;&lt;actor-name&gt;&#39;}</span>

<span class="sd">    Board position has changed::</span>

<span class="sd">        {&#39;fen&#39;: fen, , &#39;actor&#39;: &#39;&lt;actor-name&gt;&#39;}</span>

<span class="sd">    See remarks on `position2fen()`: move counts, castling are not valid, only the position</span>
<span class="sd">    part should be used.</span>

<span class="sd">    Valid move on board detected::</span>

<span class="sd">        {&#39;move&#39;: {&#39;uci&#39;: &#39;&lt;uci-format move, e.g. e2e4&gt;&#39;, &#39;fen&#39;: &#39;&lt;resulting fen position&gt;&#39;, </span>
<span class="sd">         &#39;actor&#39;: &#39;&lt;actor-name&gt;&#39;}}</span>

<span class="sd">    See remarks on `position2fen()`: move counts, castling are not valid, only the position</span>
<span class="sd">    part should be used.</span>

<span class="sd">    In order for the board to detect valid move, a list of possible valid moves has to given</span>
<span class="sd">    to the board using `move_from()`. Typically, this list is generated using the python</span>
<span class="sd">    module `python_chess`. See chess_link_agent.py for an example.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ChessLink.__init__"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">appque</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor, searches, configures and connectors to Chess Link compatible </span>
<span class="sd">        Millennium Chess Genius Exclusive or similar boards.</span>

<span class="sd">        :param appque: a Queue that receive chess board events</span>
<span class="sd">        :param name: identifies this protocol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">],</span>
                       <span class="s2">&quot;ascii&quot;</span><span class="p">:</span> <span class="s2">&quot;PNBRQK.pnbrqk&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transports</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Darwin&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;chess_link_usb&#39;</span><span class="p">],</span> <span class="s1">&#39;Linux&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;chess_link_bluepy&#39;</span><span class="p">,</span> <span class="s1">&#39;chess_link_usb&#39;</span><span class="p">],</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;chess_link_usb&#39;</span><span class="p">]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;ChessLink&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Chess Link starting&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WHITE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BLACK</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">WHITE</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;FATAL: You need Python 3.x to run this module.&quot;</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transports</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
                <span class="s2">&quot;Fatal: </span><span class="si">{}</span><span class="s2"> is not a supported platform.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Supported are: &quot;</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transports</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">appque</span> <span class="o">=</span> <span class="n">appque</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">board_mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_new_game</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trque</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>  <span class="c1"># asyncio.Queue()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">found_board</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_worker_thread</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trque</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_mutex</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_thread</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;chess_link_config.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;orientation&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Checking default configuration for board via </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span>
                <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">trans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trans</span><span class="o">.</span><span class="n">test_board</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Default board operational.&#39;</span><span class="p">)</span>
                        <span class="n">found_board</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s1">&#39;Default board not available, start scan.&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;No valid default configuration, starting board-scan: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">found_board</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">transport</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transports</span><span class="p">[</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tri</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;imported </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transport</span><span class="p">))</span>
                    <span class="n">tr</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">Transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trque</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created obj&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">is_init</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="s2">&quot;Transport </span><span class="si">{}</span><span class="s2"> loaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
                        <span class="n">address</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">search_board</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Found board on transport </span><span class="si">{}</span><span class="s2"> at address </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">tr</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="n">address</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">get_name</span><span class="p">(),</span> <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">address</span><span class="p">}</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">tr</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">write_configuration</span><span class="p">()</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Transport </span><span class="si">{}</span><span class="s2"> failed to initialize&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">tr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Internal error, import of </span><span class="si">{}</span><span class="s2"> failed: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">transport</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;No transport available, cannot connect.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Valid board available on </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">geteuid</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Do not run as root, once intial BLE scan is done.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Connecting to Chess Link via </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">open_mt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Connected to Chess Link via </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Connection to Chess Link via </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1"> FAILED.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;address&#39;</span><span class="p">]))</span></div>

<div class="viewcode-block" id="ChessLink.position_initialized"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.position_initialized">[docs]</a>    <span class="k">def</span> <span class="nf">position_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check, if a board position has been received and chess link board is online.</span>

<span class="sd">        :return: True, if board position has been received.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">board_mutex</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ChessLink.write_configuration"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.write_configuration">[docs]</a>    <span class="k">def</span> <span class="nf">write_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the configuration for hardware connection (USB/Bluetooth LE) </span>
<span class="sd">        and board orientation to &#39;chess_link_config.json&#39;</span>

<span class="sd">        :return: True on success, False on error</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">[</span><span class="s1">&#39;orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;chess_link_config.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to save default configuration </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mill_config</span><span class="p">,</span> <span class="s2">&quot;chess_link_config.json&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_event_worker_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">que</span><span class="p">,</span> <span class="n">mutex</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This background thread is started on creation of a ChessLink object. </span>
<span class="sd">        It decodes chess link encoded messages and sends json messages to the application.</span>

<span class="sd">        The event worker thread is automatically started during __init__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Chess Link worker thread started.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_active</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trque</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trque</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">appque</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;transport failure or not available.&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;s&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">67</span><span class="p">:</span>
                            <span class="n">rp</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">65</span><span class="p">]</span>
                            <span class="n">val_pos</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">position</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">64</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                                        <span class="n">c</span> <span class="o">=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="mi">8</span><span class="p">]</span>
                                        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;ascii&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                                <span class="s2">&quot;Invalid char in raw position: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                                            <span class="n">val_pos</span> <span class="o">=</span> <span class="kc">False</span>
                                            <span class="k">continue</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                                <span class="n">position</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">val_pos</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="s2">&quot;Error in board position, received </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rp</span><span class="p">)))</span>
                                <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">val_pos</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                                <span class="s1">&#39;Incomplete board position, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">val_pos</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">fen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_to_fen</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                            <span class="n">sfen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_fen</span><span class="p">(</span><span class="n">fen</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sfen</span> <span class="o">==</span> <span class="s2">&quot;RNBKQBNR/PPPPPPPP/8/8/8/8/pppppppp/rnbkqbnr&quot;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                        <span class="s2">&quot;Cable-left board detected.&quot;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">write_configuration</span><span class="p">()</span>
                                    <span class="n">position_inv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                                            <span class="n">position</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_inv</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                        <span class="s2">&quot;Cable-right board detected.&quot;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">write_configuration</span><span class="p">()</span>
                                    <span class="n">position_inv</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                                        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                                            <span class="n">position</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">position_inv</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">]</span>
                            <span class="n">fen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_to_fen</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                            <span class="n">sfen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_fen</span><span class="p">(</span><span class="n">fen</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">sfen</span> <span class="o">==</span> <span class="s2">&quot;rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR&quot;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_new_game</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">is_new_game</span> <span class="ow">is</span> <span class="kc">True</span>
                                    <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;new game&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                           <span class="s1">&#39;orientation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span><span class="p">}</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">new_game</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">appque</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">is_new_game</span> <span class="o">=</span> <span class="kc">False</span>

                            <span class="k">with</span> <span class="n">mutex</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                                        <span class="n">position</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">show_delta</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                            <span class="c1"># self.print_position_ascii(position)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">appque</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s1">&#39;fen&#39;</span><span class="p">:</span> <span class="n">fen</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_check_move</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got version reply&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                            <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">appque</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">version</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Bad length of version-reply: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got led-set reply&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got led-off reply&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got write-register reply&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                            <span class="n">reg_cont</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-&gt;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s1">&#39;Register written: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_cont</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s1">&#39;Invalid length </span><span class="si">{}</span><span class="s1"> for write-register reply&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;got read-register reply&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                            <span class="n">reg_cont</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-&gt;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s1">&#39;Register content: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reg_cont</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s1">&#39;Invalid length </span><span class="si">{}</span><span class="s1"> for read-register reply&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<div class="viewcode-block" id="ChessLink.new_game"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.new_game">[docs]</a>    <span class="k">def</span> <span class="nf">new_game</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initiate a new game</span>

<span class="sd">        :param pos: `position` array of the current position. If the hardware board has </span>
<span class="sd">                    currently a different position, all differences are indicated by </span>
<span class="sd">                    blinking leds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_led_off</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_check_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check, if current change on board is a legal move. If yes, put move into queue</span>
<span class="sd">        `appqueue`. This function is called by the background thread. In order for</span>
<span class="sd">        it to be called, `move_from` needs to have been called before.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_fen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position_to_fen</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appque</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;move&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;uci&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span><span class="p">[</span><span class="n">fen</span><span class="p">],</span> <span class="s1">&#39;fen&#39;</span><span class="p">:</span> <span class="n">fen</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_led_off</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="ChessLink.move_from"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.move_from">[docs]</a>    <span class="k">def</span> <span class="nf">move_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fen</span><span class="p">,</span> <span class="n">legal_moves</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">eval_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register all legal moves possible in current position. Once the legal moves are</span>
<span class="sd">        registered, the background thread checks for board changes, and signals a legal</span>
<span class="sd">        move using the python queue `appqueue` given during initialization.</span>

<span class="sd">        Non-legal changes or incomplete moves will cause the affected fields to blink continously.</span>

<span class="sd">        :param fen: current position</span>
<span class="sd">        :param legal_moves: dictionary of key:fen value: uci_move (e.g. e2e4). python_chess</span>
<span class="sd">                            is the recommended module to calculate all legal moves.</span>
<span class="sd">        :param color: color to move (ChessLink.WHITE or ChessLink.BLACK)</span>
<span class="sd">        :param eval_only: True: indicate ponder evals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">eval_only</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">legal_moves</span> <span class="o">=</span> <span class="n">legal_moves</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">turn</span> <span class="o">=</span> <span class="n">color</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fen_to_position</span><span class="p">(</span><span class="n">fen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eval_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fen_to_position</span><span class="p">(</span><span class="n">fen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_delta</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">eval_position</span><span class="p">,</span>
                            <span class="n">freq</span><span class="o">=</span><span class="mh">0x15</span><span class="p">,</span> <span class="n">ontime1</span><span class="o">=</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">ontime2</span><span class="o">=</span><span class="mh">0x01</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChessLink.show_deltas"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.show_deltas">[docs]</a>    <span class="k">def</span> <span class="nf">show_deltas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signal leds to show difference between current position on board, and intended position.</span>
<span class="sd">        This is used to signal moves by other agents, or discrepancies with the current position.</span>

<span class="sd">        Up to four half-moves can be indicated at sequence of up to 5 positions.</span>

<span class="sd">        :param positions: array of `position` arrays. Max length is 5 (4 half-moves incl. start</span>
<span class="sd">                          position)</span>
<span class="sd">        :param freq: Blink frequency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">npos</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>
        <span class="n">dpos</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ply</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npos</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">ply</span><span class="o">*</span><span class="mi">2</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="n">ply</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">positions</span><span class="p">[</span><span class="n">ply</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">positions</span><span class="p">[</span><span class="n">ply</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">dpos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">frame</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dpos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_mv_led</span><span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set_mv_led</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">freq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the leds on board according to pos array, used by `show_deltas`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">leds</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span><span class="o">+</span><span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">leds</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ChessLink.show_delta"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.show_delta">[docs]</a>    <span class="k">def</span> <span class="nf">show_delta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">ontime1</span><span class="o">=</span><span class="mh">0x0f</span><span class="p">,</span> <span class="n">ontime2</span><span class="o">=</span><span class="mh">0xf0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicate difference between two `position` arrays using the board&#39;s leds.</span>

<span class="sd">        :param pos1: `position` array of the start position</span>
<span class="sd">        :param pos2: `position` array of the target position</span>
<span class="sd">        :param freq: blink frequency, see `magic-link.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;`_.</span>
<span class="sd">        :param ontime1: 8-bit value, bits indicate cycles led is on.</span>
<span class="sd">        :param ontime2: 8-bit value, bits indicate cycles led is off.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dpos</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pos2</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pos1</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">pos1</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dpos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dpos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_led</span><span class="p">(</span><span class="n">dpos</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ontime1</span><span class="p">,</span> <span class="n">ontime2</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChessLink.set_led"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.set_led">[docs]</a>    <span class="k">def</span> <span class="nf">set_led</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ontime1</span><span class="p">,</span> <span class="n">ontime2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Static blinking leds according to `position`.</span>

<span class="sd">        :param pos: `position` array, field != 0 indicates a led that should blink.</span>
<span class="sd">        :param freq: blink frequency, see `magic-link.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;`_.</span>
<span class="sd">        :param ontime1: 8-bit value, bits indicate cycles led is on.</span>
<span class="sd">        :param ontime2: 8-bit value, bits indicate cycles led is off.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">leds</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span><span class="o">+</span><span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                            <span class="n">leds</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">leds</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="s2">&quot;00&quot;</span>
                    <span class="k">elif</span> <span class="n">leds</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">ontime1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">ontime2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChessLink.set_led_off"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.set_led_off">[docs]</a>    <span class="k">def</span> <span class="nf">set_led_off</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch off all leds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChessLink.get_debounce"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.get_debounce">[docs]</a>    <span class="k">def</span> <span class="nf">get_debounce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronuosly request the current debounce setting. The answer will be</span>
<span class="sd">        written to the queue `appqueue` given during initialization.</span>

<span class="sd">        See see `magic-link.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;`_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="o">+</span><span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChessLink.set_debounce"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.set_debounce">[docs]</a>    <span class="k">def</span> <span class="nf">set_debounce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the debounce-value. Debouncing helps to prevent random fluke events. Should be tested</span>
<span class="sd">        together with different `set_scan_time_ms()` values.</span>

<span class="sd">        :param count: 0-4, 0: no debounce, 1-4: 1-4 scan times debounce.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;W02&quot;</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Invalid debounce count </span><span class="si">{}</span><span class="s1">, should be 0: no debounce, 1 .. 4: 1-4  scan times debounce&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 3: no debounce, 4: 2 scans debounce, -&gt; 7: 4 scans</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">count</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting board scan debounce to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">))</span></div>

<div class="viewcode-block" id="ChessLink.get_led_brightness_percent"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.get_led_brightness_percent">[docs]</a>    <span class="k">def</span> <span class="nf">get_led_brightness_percent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronuosly request the current led brightness setting. The answer will be</span>
<span class="sd">        written to the queue `appqueue` given during initialization.</span>

<span class="sd">        See see `magic-link.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;`_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="o">+</span><span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ChessLink.set_led_brightness"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.set_led_brightness">[docs]</a>    <span class="k">def</span> <span class="nf">set_led_brightness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the led brighness.</span>

<span class="sd">        :param level: 0.0 - 1.0: 0(darkest) up to 1.0(brightest).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;W04&quot;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Invalid brightness level </span><span class="si">{}</span><span class="s1">, shouldbe between 0(darkest)..1.0(brightest)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ilevel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">ilevel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Setting led brightness to </span><span class="si">{}</span><span class="s2"> (bri=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ilevel</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span></div>

<div class="viewcode-block" id="ChessLink.get_scan_time_ms"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.get_scan_time_ms">[docs]</a>    <span class="k">def</span> <span class="nf">get_scan_time_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronuosly request the current scan time setting. The answer will be</span>
<span class="sd">        written to the queue `appqueue` given during initialization.</span>

<span class="sd">        See see `magic-link.md &lt;https://github.com/domschl/python-mchess/blob/master/mchess/magic-board.md&gt;`_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span><span class="o">+</span><span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link.&quot;</span><span class="p">)</span></div>

    <span class="c1"># default is scan every 40.96 ms, 24.4 scans per second.</span>
<div class="viewcode-block" id="ChessLink.set_scan_time_ms"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.set_scan_time_ms">[docs]</a>    <span class="k">def</span> <span class="nf">set_scan_time_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_ms</span><span class="o">=</span><span class="mi">41</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the scan time value. Lower scan times make the board less susceptible to random unexpected</span>
<span class="sd">        events and can be used together with `set_debounce()` to prevent random fluke events.</span>

<span class="sd">        :param scan_ms: 30.72(fastest)-522.24(slowest), scan time in ms. A value around 100ms is </span>
<span class="sd">                        recommended, board default is 41ms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;W01&quot;</span>
        <span class="k">if</span> <span class="n">scan_ms</span> <span class="o">&lt;</span> <span class="mf">2.048</span> <span class="o">*</span> <span class="mf">15.0</span> <span class="ow">or</span> <span class="n">scan_ms</span> <span class="o">&gt;</span> <span class="mf">255.0</span> <span class="o">*</span> <span class="mf">2.048</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Invalid scan_ms </span><span class="si">{}</span><span class="s1">, shouldbe between 30.72(fastest, might not work)..522.24(slowest, about 2 scans per sec))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan_ms</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iscans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan_ms</span><span class="o">/</span><span class="mf">2.048</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iscans</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
                <span class="n">iscans</span> <span class="o">=</span> <span class="mi">15</span>
            <span class="k">if</span> <span class="n">iscans</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                <span class="n">iscans</span> <span class="o">=</span> <span class="mi">255</span>
            <span class="n">cmd</span> <span class="o">+=</span> <span class="n">clp</span><span class="o">.</span><span class="n">hex2</span><span class="p">(</span><span class="n">iscans</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Setting scan_ms intervall to </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">ms (</span><span class="si">{}</span><span class="s2"> scans per sec)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iscans</span><span class="p">,</span> <span class="n">scan_ms</span><span class="p">,</span> <span class="mf">1000.0</span><span class="o">/</span><span class="n">scan_ms</span><span class="p">))</span></div>

    <span class="c1"># TODO: move this?</span>
<div class="viewcode-block" id="ChessLink.short_fen"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.short_fen">[docs]</a>    <span class="k">def</span> <span class="nf">short_fen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility-function to cut off all information after the actual position, since the board</span>
<span class="sd">        does not know about move counts or castling.</span>

<span class="sd">        E.g. `rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1` is transformed to</span>
<span class="sd">        `rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR`</span>

<span class="sd">        :returns: position-only part of the fen string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">fen</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Invalid fen position &lt;</span><span class="si">{}</span><span class="s1">&gt; in short_fen&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fen</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fen</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="ChessLink.position_to_fen"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.position_to_fen">[docs]</a>    <span class="k">def</span> <span class="nf">position_to_fen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a 8x8 `position` array to a fen position. Typically, an 8x8 `position` is generated</span>
<span class="sd">        by the Chess Link board, which has no information about the current move, side to move, or</span>
<span class="sd">        castling status.</span>

<span class="sd">        The returned FEN has always ending `w KQkq - 0 1` after the actual position (only rudimentary</span>
<span class="sd">        checks for castling are done)</span>

<span class="sd">        :returns: FEN string derived from postion-array </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fen</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">blanks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;ascii&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Internal FEN error, could not translation </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                    <span class="n">blanks</span> <span class="o">=</span> <span class="n">blanks</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">blanks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">fen</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">blanks</span><span class="p">)</span>
                        <span class="n">blanks</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">fen</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">blanks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fen</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">blanks</span><span class="p">)</span>
                <span class="n">blanks</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">fen</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
        <span class="n">fen</span> <span class="o">+=</span> <span class="s1">&#39; w &#39;</span>
        <span class="n">castle</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">castle</span> <span class="o">+=</span> <span class="s2">&quot;K&quot;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">castle</span> <span class="o">+=</span> <span class="s2">&quot;Q&quot;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">castle</span> <span class="o">+=</span> <span class="s2">&quot;k&quot;</span>
        <span class="k">if</span> <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">4</span><span class="p">:</span>
            <span class="n">castle</span> <span class="o">+=</span> <span class="s2">&quot;q&quot;</span>
        <span class="k">if</span> <span class="n">castle</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">castle</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">fen</span> <span class="o">+=</span> <span class="n">castle</span><span class="o">+</span><span class="s1">&#39; - 0 1&#39;</span>
        <span class="k">return</span> <span class="n">fen</span></div>

<div class="viewcode-block" id="ChessLink.fen_to_position"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.fen_to_position">[docs]</a>    <span class="k">def</span> <span class="nf">fen_to_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a FEN position into an 8x8 `position` array.</span>

<span class="sd">        Note that the current implementation of `position` arrays does not maintain move-counts,</span>
<span class="sd">        castling stati or any history data.</span>

<span class="sd">        :returns: 8x8 `position` array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">position</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)]</span>
        <span class="n">fenp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_fen</span><span class="p">(</span><span class="n">fen</span><span class="p">)</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">fenp</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span>
                <span class="n">fi</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="s1">&#39;1&#39;</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">ci</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;ascii&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;ascii&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figrep</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">ci</span> <span class="o">==</span> <span class="o">-</span><span class="mi">99</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;Internal FEN2 error decoding </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">position</span><span class="p">[</span><span class="mi">7</span><span class="o">-</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">ci</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="ow">and</span> <span class="n">fenp</span><span class="p">[</span><span class="n">fi</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Illegal fen: missing &#39;/&#39; </span><span class="si">{}{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fenp</span><span class="p">[</span><span class="n">fi</span><span class="p">],</span> <span class="n">fi</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="n">fi</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">position</span></div>

    <span class="k">def</span> <span class="nf">_open_transport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function to load transport modules (USB or bluetooth)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tri</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;imported </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transport</span><span class="p">))</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">Transport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trque</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;created obj&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">is_init</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Transport </span><span class="si">{}</span><span class="s2"> loaded.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
                <span class="k">return</span> <span class="n">tr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Transport </span><span class="si">{}</span><span class="s2"> failed to initialize&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">get_name</span><span class="p">()))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Internal error, import of </span><span class="si">{}</span><span class="s2"> failed, transport not available.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">transport</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="ChessLink.reset"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset Chess Link module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Chess Link reset initiated, will take 3 secs.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link, can&#39;t reset.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;?&#39;</span></div>

<div class="viewcode-block" id="ChessLink.get_version"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.get_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronuosly request the Chess Link version number. The answer will be</span>
<span class="sd">        written to the queue `appqueue` given during initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link, can&#39;t get version.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;?&#39;</span></div>

<div class="viewcode-block" id="ChessLink.get_position"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.get_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronuosly request the Chess Link board position. The answer will be</span>
<span class="sd">        written to the queue `appqueue` given during initialization.</span>

<span class="sd">        By default, the Chess Link board sends a position to `appqueue` on all changes</span>
<span class="sd">        to the board position, so explicit calls to `get_position()` should not be required</span>
<span class="sd">        most of the times.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">write_mt</span><span class="p">(</span><span class="s2">&quot;S&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not connected to Chess Link, can&#39;t get position.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;?&#39;</span></div>

<div class="viewcode-block" id="ChessLink.set_orientation"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.set_orientation">[docs]</a>    <span class="k">def</span> <span class="nf">set_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the Chess Link board orientation.</span>

<span class="sd">        Setting the orientation is only necessary, when autodecection cannot work,</span>
<span class="sd">        because the board has never been set to a start position.</span>

<span class="sd">        :param orientation: True: cable right, False: cable left.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_configuration</span><span class="p">()</span></div>

<div class="viewcode-block" id="ChessLink.get_orientation"><a class="viewcode-back" href="../index.html#chess_link.ChessLink.get_orientation">[docs]</a>    <span class="k">def</span> <span class="nf">get_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronuosly request the Chess Link board orientation. The answer will be</span>
<span class="sd">        written to the queue `appqueue` given during initialization.</span>

<span class="sd">        ChessLink tries to autodetect the orientation of the board by looking for</span>
<span class="sd">        initial start positions.</span>

<span class="sd">        If the board has never been set to the initial start position, the orientation</span>
<span class="sd">        must be set using `set_orientation()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientation</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">mchess</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Dominik Schlösser.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>